name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Build Debug APK (no wrapper jar)
        run: |
          set -euxo pipefail

          # Detect Android project root (root or ./android)
          ROOT="."
          if [ -f "./android/settings.gradle" ] || [ -f "./android/settings.gradle.kts" ]; then
            ROOT="./android"
          fi
          echo "Project root: $ROOT"

          # Try to read Gradle distribution from gradle-wrapper.properties
          PROPS="$ROOT/gradle/wrapper/gradle-wrapper.properties"
          if [ -f "$PROPS" ]; then
            DIST_URL=$(grep -E '^distributionUrl=' "$PROPS" | cut -d= -f2- | sed 's/\\:/:/g')
          else
            # Fallback (if properties are also missing)
            DIST_URL="https://services.gradle.org/distributions/gradle-8.7-bin.zip"
          fi
          echo "Using Gradle: $DIST_URL"

          curl -L "$DIST_URL" -o /tmp/gradle.zip
          unzip -q /tmp/gradle.zip -d /tmp/gradle
          GRADLE_BIN=$(find /tmp/gradle -type f -path "*/bin/gradle" -print -quit)

          cd "$ROOT"
          "$GRADLE_BIN" :app:assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-alchemy-debug-apk
          path: "**/app/build/outputs/apk/debug/*.apk"
          if-no-files-found: error
